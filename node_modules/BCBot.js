var builder = require('botbuilder');
var utils = require('../util.js');

var BCBot = function(model) {
	utils.Extendable.call(this);
	this.model = model;
	this.dialog = new builder.LuisDialog(model);
	this.bot = new builder.BotConnectorBot();
}
BCBot.prototype = new utils.Extendable();
BCBot.prototype.constructor = BCBot;
BCBot.prototype.addCommand = function(factory) {
	if (factory.getType() == "BotCommandFactory") {
		this.dialog.on(factory.getIntent(), factory.getAction());
	} else {
		utils.throwIncorrectFactoryError();
	}
};
BCBot.prototype.attach = function(url) {
	this.bot.add(url, this.dialog);
};
BCBot.prototype.setDefault = function(factory) {
	if (factory.getType() == "BotDefaultCommandFactory") {
		this.dialog.onDefault(factory.getAction());
	} else {
		utils.throwIncorrectFactoryError();
	}
};
// BCBot.prototype.listenStdin = function() {
// 	this.bot.listenStdin();
// }

var model = 'https://api.projectoxford.ai/luis/v1/application?id=f86def56-4901-4874-89c1-19f43e9e7d9d&subscription-key=9b8a3f03610f4c5aa8f07e1b31664d27';
var bot = new BCBot(model);
var cortanaBot = bot.bot;
var dialog = bot.dialog;
cortanaBot.add('/', dialog);

//dialog.on('mkdir', [
//function builder.DialogAction.send('What should I call this folder?'));
//dialog.on('builtin.intent.alarm.delete_alarm', builder.DialogAction.send('Deleting Alarm'));

dialog.on('mkdir', [
    function (session, args, next) {
        // Resolve and store any entities passed from LUIS.
        // var location = builder.EntityRecognizer.findEntity(args.entities, 'location');
        //
        // // Prompt for title
        // if (!location) {
        //     builder.Prompts.text(session, 'Where do you want to make it?');
        // } else {
        //     next();
        // }
        session.send(JSON.stringify(args.entities));
    },
    function (session, results, next) {
        /*var alarm = session.dialogData.alarm;
        if (results.response) {
            alarm.title = results.response;
        }

        // Prompt for time (title will be blank if the user said cancel)
        if (alarm.title && !alarm.timestamp) {
            builder.Prompts.time(session, 'What time would you like to set the alarm for?');
        } else {*/
            next();
        //}
    },
    function (session, results) {
        /*var alarm = session.dialogData.alarm;
        if (results.response) {
            var time = builder.EntityRecognizer.resolveTime([results.response]);
            alarm.timestamp = time ? time.getTime() : null;
        }

        // Set the alarm (if title or timestamp is blank the user said cancel)
        if (alarm.title && alarm.timestamp) {
            // Save address of who to notify and write to scheduler.
            alarm.to = session.message.from;
            alarm.from = session.message.to;
            alarms[alarm.title] = alarm;

            // Send confirmation to user
            var date = new Date(alarm.timestamp);
            var isAM = date.getHours() < 12;
            session.send('Creating alarm named "%s" for %d/%d/%d %d:%02d%s',
                alarm.title,
                date.getMonth() + 1, date.getDate(), date.getFullYear(),
                isAM ? date.getHours() : date.getHours() - 12, date.getMinutes(), isAM ? 'am' : 'pm');
        } else {*/
            session.send('Ok... no problem.');
        //}
    }
]);

dialog.onDefault(builder.DialogAction.send("I'm sorry I didn't understand. I can only create and delete alarms."));



module.exports = cortanaBot;

/*
<<<<<<< HEAD
bot.add('/', function (session) {
  if (!session.userData.name) {
      session.beginDialog('/profile');
  } else {
      session.send('Hello %s!', session.userData.name);
  }
});

bot.add('/profile', [
  function (session) {
      builder.Prompts.text(session, 'Hi! What is your name?');
  },
  function (session, results) {
      session.userData.name = results.response;
      session.endDialog();
  }
]);


module.exports = bot;
=======
*/
/*
var model = 'https://api.projectoxford.ai/luis/v1/application?id=c413b2ef-382c-45bd-8ff0-f76d60e2a821&subscription-key=ec8bb8f3d3d74a898c1cd1ddd7e0c8c8&q=';
var dialog = new builder.LuisDialog(model);
var cortanaBot = new builder.TextBot();
cortanaBot.add('/', dialog);
dialog.on('builtin.intent.alarm.set_alarm', builder.DialogAction.send('Creating Alarm'));
dialog.on('builtin.intent.alarm.delete_alarm', builder.DialogAction.send('Deleting Alarm'));
dialog.onDefault(builder.DialogAction.send("I'm sorry I didn't understand. I can only create & delete alarms."));

var dialog = BCBot.dialog;

console.log((new utils.BotCommandFactory("1", "2")).getIntent());


// test bot
var cortanaModel = 'https://api.projectoxford.ai/luis/v1/application?id=c413b2ef-382c-45bd-8ff0-f76d60e2a821&subscription-key=ec8bb8f3d3d74a898c1cd1ddd7e0c8c8&q=';
var model2 = 'https://api.projectoxford.ai/luis/v1/application?id=f86def56-4901-4874-89c1-19f43e9e7d9d&subscription-key=9b8a3f03610f4c5aa8f07e1b31664d27&q=';

var testBot = new BCBot(model2);
testBot.addCommand(new utils.BotCommandFactory('mkdir', builder.DialogAction.send('mkdir')));

// var testBot = new BCBot(cortanaModel);
// testBot.addCommand(new BotCommandFactory('builtin.intent.alarm.set_alarm', builder.DialogAction.send('Creating Alarm')));
// testBot.addCommand(new BotCommandFactory('builtin.intent.alarm.delete_alarm', builder.DialogAction.send('Deleting Alarm')));

testBot.setDefault(new utils.BotDefaultCommandFactory(builder.DialogAction.send("I'm sorry I didn't understand")));
module.exports= testBot;
//testBot.listenStdin();
//testBot.attach('/');

// bot.add('/', function (session) {
  // session.send('Hello World');
// });

// module.exports = bot;
// module.exports = cortanaBot;
*/
